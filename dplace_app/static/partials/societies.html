<div class="container results">
    <div class="row">
        <span>
            <p class="pull-left lead">Societies<span ng-show="results.societies.length">({{ results.societies.length }})</span></p>
        </span>
    </div>
    <tabset>
        <tab heading="Table">
            <div class="row">
                <div ng-hide="results.societies.length">
                    <p class="text-center help-block search-help"></p>
                </div>
                <table class="table" ng-show="results.societies.length">
                    <tr>
                        <th>Name</th>
                        <th>ISO Code</th>
                        <th>Language</th>
                        <th>Trees</th>
                        <th ng-repeat="variable in results.variable_descriptions">{{ variable.name }}</th>
                        <th ng-repeat="environmental in results.environmental_variables">{{ environmental.name }}</th>
                        <th ng-show="results.languages">Language</th>
                        <th ng-show="results.geographic_regions">Geographic Region</th>
                    </tr>
                    <tr ng-repeat="society_result in results.societies">
                        <td><span class="circle" ng-style="society_result.society.style"></span>
                            <a ng-href="/society/{{ society_result.society.id }}" target="_blank">{{ society_result.society.name }}</a>
                        </td>
                        <td>{{ society_result.society.iso_code }}</td>
                        <td>{{ society_result.society.language | formatLanguageName }}</td>
                        <td><a popover="{{society_result.society.trees | formatLanguageTrees }}" title="'Trees'">{{ society_result.society.trees | countOrBlank }}</a></td>
                        <td ng-repeat="variable in results.variable_descriptions">
                            {{ society_result.variable_coded_values | formatVariableCodeValues:variable.id }}
                        </td>
                        <td ng-repeat="environmental in results.environmental_variables">
                            {{ society_result.environmental_values | formatEnvironmentalValues:environmental.name }}
                        </td>
                        <td ng-show="results.languages">
                            {{ society_result.languages | formatLanguage}}
                        </td>
                        <td ng-show="results.geographic_regions">
                            {{ society_result.geographic_regions | formatGeographicRegion}}
                        </td>
                    </tr>
                </table>
            </div>
        </tab>
        <tab heading="Map" select="visible=true" deselect="visible=false">
            <div class="row">
                <h4 ng-show="variables.length > 0">Choose a variable:</h4>
                <select 
                    ng-model="results.chosenVariable"
                    class="form-control"
                    ng-options="variable.name for variable in variables"
                    ng-init="results.chosenVariable=variables[0]"
                    ng-change="changeMap(results.chosenVariable)"
                    ng-show="variables.length > 0"
                 >
                 </select>
             </div>
            <dplace-map results="results" map-div-id="result-map" visible="visible" query="query" chosen="results.chosenVariable"></dplace-map>
            <table id="mapLegend" style="position:absolute; margin-top:-270px; margin-left:750px; margin-right:10px;">
                <tr class="download-links">
                </tr>
                <tr ng-show="results.chosenVariable.data_type !== 'CONTINUOUS'" ng-repeat="code in results.code_ids[results.chosenVariable.id]">
                    <td>
                        <svg height="20" width="20">
                            <circle
                                    cx="10"
                                    cy="10"
                                    r="4.5"
                                    fill="{{code.code|colorNode:results.code_ids[results.chosenVariable.id]}}"
                                    stroke="#000"
                                    stroke-width="0.5"
                                    />
                            </svg>
                    </td>
                    <td>{{code.description}}</td>
                </tr>
                <tr ng-show="results.chosenVariable.data_type == 'CONTINUOUS'">
                    <td>
                        <svg height="20" width="20">
                            <circle
                                    cx="10"
                                    cy="10"
                                    r="4.5"
                                    fill="hsl(360, 100%, 100%)"
                                    stroke="#000"
                                    stroke-width="0.5"
                                    />
                            </svg>
                        </td>
                    <td>Missing Data</td>
               </tr>
                <tr ng-show="results.chosenVariable.data_type == 'CONTINUOUS'">
                    <td>
                        <svg class="bf-cont-gradient" height="250" height="30">
                            <defs>
                                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:hsl(0, 65%, 95%);stop-opacity:1" />
                                    <stop offset="50%" style="stop-color:hsl(0, 65%, 50%);stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:hsl(0, 65%, 0%);stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <rect x="10" fill="url(#grad1)" height="30" width="200" />
                            <text x="0" y="45">{{results.code_ids[results.chosenVariable.id].min}} {{results.code_ids[results.chosenVariable.id].units}}</text>
                            <text x="200" y="45">{{results.code_ids[results.chosenVariable.id].max}} {{results.code_ids[results.chosenVariable.id].units}}</text>
                        </svg>
                    </td>
                </tr>
                
                <tr ng-repeat="code in results.classifications|joinDictItems">
                    <td>
                        <svg height="20" width="20">
                            <circle
                                    cx="10"
                                    cy="10"
                                    r="4.5"
                                    fill="{{code.id|colorNode:(results.classifications|joinDictItems)}}"
                                    stroke="#000"
                                    stroke-width="0.5"
                                    />
                            </svg>
                    </td>
                    <td>{{code.name}}</td>
                </tr>
            </table>
            <svg class="legend-for-download" style="visibility:hidden;">
            </svg>
        </tab>
        <tab heading="Tree">
            <h4> Phylogenies </h4>
            <select
                ng-model="results.selectedTree"
                class="form-control"
                style="width:100%"
                ng-change="treeSelected()"
                ng-options="tree.name for tree in results.language_trees"
                >
                <option value="">Select a Phylogeny</option>
            </select>
            <div class="tree-download"></div>

            <div id="legend" ng-show="results.selectedTree">
                <table ng-repeat="(id, code) in results.code_ids">
                    <tr data-toggle="collapse" data-target="#{{code.CID}}" class="accordion-toggle" style="cursor:pointer;"><th colspan="2">{{code.CID}}: {{code.name}}</th></tr>
                    <tr>
                        <td class="hiddenRow">
                            <div class="accordion-body collapse" id="{{code.CID}}">
                                <svg ng-show="!code.bf_var" height="{{code.svgSize}}" class="tree-legend" ng-class="bf{{code.bf_var}}">
                                    <g ng-repeat="c in code" transform="{{$index|transformG}}">
                                        <circle
                                                cx="10"
                                                cy="10"
                                                r="4.5"
                                                fill="{{c.code|colorNode:code}}"
                                                stroke="#000"
                                                stroke-width="0.5"
                                                />
                                        <text x="20" y="15">{{c.description}}</text>
                                    </g>
                                </svg>
                                <svg ng-show="code.bf_var" class="bf-cont-gradient" height="80" height="30">
                                    <defs>
                                        <linearGradient id="g{{code.CID}}" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:hsl(0, 65%, 95%);stop-opacity:1" />
                                            <stop offset="50%" style="stop-color:hsl(0, 65%, 50%);stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:hsl(0, 65%, 0%);stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle
                                            cx="10"
                                            cy="10"
                                            r="4.5"
                                            fill="hsl(360, 100%, 100%)"
                                            stroke="#000"
                                            stroke-width="0.5"
                                            />
                                        <text x="20" y="15">Missing Data</text>
                                    <rect x="10" y="25" fill="url(#g{{code.CID}})" height="30" width="200" />
                                    <text x="0" y="70">{{code.min}} {{code.units}}</text>
                                    <text x="200" y="70">{{code.max}} {{code.units}}</text>
                                </svg>
                                
                              </div>
                        </td>
                    </tr>
                </table>

                <table ng-repeat="environmental in results.environmental_variables">
                    <tr><th>E1: {{environmental.name}}</th></tr>
                </table>
                <table ng-show="results.classifications">
                    <tr style="cursor:pointer;"><th colspan="2">Language Classifications</th></tr>
                    <tr>
                        <td class="">
                            <div id="{{classification}}">
                                <svg height="100" class="tree-legend-langs">
                                    <g ng-repeat="classification in results.classifications|joinDictItems" transform="{{$index|transformG}}">
                                        <circle
                                                cx="10"
                                                cy="10"
                                                r="4.5"
                                                fill="{{classification.id|colorNode:(results.classifications|joinDictItems)}}"
                                                stroke="#000"
                                                stroke-width="0.5"
                                                />
                                        
                                        <text x="20" y="15">{{classification.name}}</text>
                                    </g>
                                </svg>
                              </div>
                        </td>
                    </tr>
                </table>
            </div>
            <language-phylogeny></language-phylogeny>
        </tab>
        <tab heading="Download" select="generateDownloadLinks()">
            <div class="row">
                <h4>Download results as:</h4>
                <ul>
                    <li>
                        <a ng-href="{{ csvDownloadLink }}" class="btn btn-info btn-dplace-download">CSV</a>
                    </li>
                </ul>
            </div>
        </tab>
    </tabset>
</div>